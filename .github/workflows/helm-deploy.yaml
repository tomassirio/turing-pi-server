name: Helm Deploy to Kubernetes

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (dev, prod)'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace'
        required: true
        type: string
      changed-services:
        description: 'JSON array of changed services'
        required: false
        type: string
        default: '[]'
      deploy-all:
        description: 'Deploy all services regardless of changes'
        required: false
        type: boolean
        default: false
    secrets:
      TWINGATE_SERVICE_KEY:
        description: 'Twingate service key for cluster access'
        required: true
      KUBECONFIG_CONTENT:
        description: 'Base64 encoded kubeconfig file'
        required: true
      SOPS_AGE_KEY:
        description: 'SOPS AGE private key for decrypting secrets'
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-services.outputs.services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine services to deploy
        id: set-services
        run: |
          CHANGED_SERVICES='${{ inputs.changed-services }}'
          DEPLOY_ALL=${{ inputs.deploy-all }}
          
          if [ "$DEPLOY_ALL" = "true" ]; then
            echo "Deploying all services..."
            # Get all services from the services directory, excluding archived, testing, and common
            SERVICES=$(ls -d services/*/ | xargs -n 1 basename | grep -v "archived\|testing\|common" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          elif [ "$CHANGED_SERVICES" != "[]" ] && [ "$CHANGED_SERVICES" != "" ]; then
            echo "Deploying changed services: $CHANGED_SERVICES"
            SERVICES="$CHANGED_SERVICES"
          else
            echo "No services to deploy"
            SERVICES="[]"
          fi
          
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "Services to deploy: $SERVICES"

  deploy:
    needs: prepare
    if: needs.prepare.outputs.services != '[]' && needs.prepare.outputs.services != ''
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.prepare.outputs.services) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Connect to Twingate
        uses: twingate/github-action@v1
        with:
          service-key: ${{ secrets.TWINGATE_SERVICE_KEY }}

      - name: Setup Kubernetes
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_CONTENT }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Install SOPS
        run: |
          SOPS_VERSION="3.9.0"
          curl -LO "https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64"
          sudo mv sops-v${SOPS_VERSION}.linux.amd64 /usr/local/bin/sops
          chmod +x /usr/local/bin/sops
          sops --version

      - name: Install Helm Secrets Plugin
        run: |
          # Install plugin
          helm plugin install https://github.com/jkroepke/helm-secrets --version v4.6.0
          
          # Verify installation
          helm plugin list
          helm secrets --version
          
          # Persist plugin path for future steps
          PLUGIN_PATH=$(helm env HELM_PLUGINS)
          echo "HELM_PLUGINS=$PLUGIN_PATH" >> $GITHUB_ENV

      - name: Setup SOPS Age Key
        run: |
          mkdir -p ~/.config/sops/age
          echo "${{ secrets.SOPS_AGE_KEY }}" > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt
          
          # Set environment variables for SOPS
          echo "SOPS_AGE_KEY_FILE=$HOME/.config/sops/age/keys.txt" >> $GITHUB_ENV
          
          # Verify SOPS can decrypt
          echo "Testing SOPS decryption..."
          if [ -f "services/qbittorrent/secrets.yaml" ]; then
            sops -d services/qbittorrent/secrets.yaml > /dev/null && echo "âœ“ SOPS working"
          fi

      - name: Create namespace
        run: |
          # Create namespace if it doesn't exist
          kubectl create namespace ${{ inputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -
          echo "âœ“ Namespace ${{ inputs.namespace }} ready"

      - name: Deploy ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          
          echo "================================================"
          echo "Deploying $SERVICE to ${{ inputs.namespace }}..."
          echo "================================================"
          
          # Handle storage as a special case
          if [ "$SERVICE" = "storage" ]; then
            echo "ðŸ“¦ Deploying storage chart..."
            helm upgrade --install storage ./config/storage \
              --create-namespace \
              --wait --timeout 5m \
              -f ./config/global-values.yaml
            
            echo "âœ“ Storage deployed successfully"
            exit 0
          fi

          # Handle cluster-secrets as a special case
          if [ "$SERVICE" = "cluster-secrets" ]; then
            echo "ðŸ” Deploying cluster-secrets chart..."
            helm secrets upgrade --install cluster-secrets ./config/secrets \
              --namespace "${{ inputs.namespace }}" \
              --create-namespace \
              --wait --timeout 5m \
              -f ./config/secrets/secrets.yaml
            
            echo "âœ“ Cluster secrets deployed successfully"
            exit 0
          fi
          
          SERVICE_PATH="./services/$SERVICE"
          
          if [ ! -d "$SERVICE_PATH" ]; then
            echo "âš ï¸  Service directory not found: $SERVICE_PATH"
            exit 0
          fi
          
          # Prepare Helm arguments
          HELM_ARGS=(
            --namespace "${{ inputs.namespace }}"
            --create-namespace
            --wait
            --timeout 5m
            -f ./config/global-values.yaml
          )
          
          # Override ingress host and storage for dev environment
          if [ "${{ inputs.environment }}" = "dev" ]; then
            echo "ðŸ”§ Setting dev ingress host: ${SERVICE}.localhome-dev.com"
            HELM_ARGS+=(--set "ingress.host=${SERVICE}.localhome-dev.com")
            HELM_ARGS+=(--set "ingress.hosts[0].host=${SERVICE}.localhome-dev.com")
            HELM_ARGS+=(--set "ingress.hosts[0].paths[0].path=/")
            HELM_ARGS+=(--set "ingress.hosts[0].paths[0].pathType=ImplementationSpecific")
            
            echo "ðŸ”§ Setting dev storage (NFS instead of NAS)"
            # Try all common patterns for different services
            HELM_ARGS+=(--set "persistence.data.existingClaim=nfs-pvc")
            HELM_ARGS+=(--set "persistence.config.existingClaim=nfs-config-pvc")
            HELM_ARGS+=(--set "persistence.restore.existingClaim=nfs-config-pvc")
            HELM_ARGS+=(--set "persistence.backup.existingClaim=nfs-config-pvc")
            HELM_ARGS+=(--set "persistence.cache.existingClaim=nfs-config-pvc")
            HELM_ARGS+=(--set "persistence.repos.existingClaim=nfs-config-pvc")
            HELM_ARGS+=(--set "volumes[0].persistentVolumeClaim.claimName=nfs-config-pvc")
          fi
          
          # Update dependencies
          echo "ðŸ“¦ Updating Helm dependencies..."
          helm dependency update --skip-refresh "$SERVICE_PATH"

          # Check if service has secrets
          if [ -f "$SERVICE_PATH/secrets.yaml" ]; then
            echo "ðŸ” Service has encrypted secrets, decrypting with SOPS..."
            
            # Decrypt secrets to temporary file
            sops -d "$SERVICE_PATH/secrets.yaml" > "$SERVICE_PATH/secrets.dec.yaml"
            
            # Deploy with decrypted secrets
            helm upgrade --install "$SERVICE" "$SERVICE_PATH" \
              --namespace "${{ inputs.namespace }}" \
              "${HELM_ARGS[@]}" \
              -f "$SERVICE_PATH/secrets.dec.yaml"
            
            # Clean up decrypted file
            rm -f "$SERVICE_PATH/secrets.dec.yaml"
          else
            echo "ðŸ“¦ Deploying service with standard helm..."
            helm upgrade --install "$SERVICE" "$SERVICE_PATH" \
              --namespace "${{ inputs.namespace }}" \
              "${HELM_ARGS[@]}"
          fi
          
          echo "âœ“ $SERVICE deployed successfully"

      - name: Display pod logs on failure
        if: failure()
        run: |
          SERVICE="${{ matrix.service }}"
          echo "=== $SERVICE logs ==="
          
          # Get pod name
          POD=$(kubectl get pods -l app=$SERVICE -n ${{ inputs.namespace }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          
          if [ -n "$POD" ]; then
            # Check for init container logs
            echo "--- Init container logs ---"
            kubectl logs $POD -n ${{ inputs.namespace }} -c init-config --tail=50 2>/dev/null || echo "No init container or logs not available"
            
            echo ""
            echo "--- Main container logs ---"
            kubectl logs $POD -n ${{ inputs.namespace }} --tail=50 || true
          else
            echo "Pod not found for service: $SERVICE"
          fi
